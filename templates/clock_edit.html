<div id="time-clock" class="clock-container">
  <span class="label">Time</span>
  <div class="mc-clock-wrapper">
    <div class="mc-clock" id="mc-clock">
      <svg viewBox="0 0 64 64" class="clock-svg">
        <defs>
          <clipPath id="innerCircleEdit">
            <circle cx="32" cy="32" r="22" />
          </clipPath>
          <clipPath id="bottomHalfEdit">
            <rect x="0" y="32" width="64" height="32" />
          </clipPath>
        </defs>
        <g id="clock-disc" clip-path="url(#innerCircleEdit)">
          <rect x="0" y="0" width="64" height="32" fill="#4A90D9" />
          <rect x="0" y="26" width="64" height="6" fill="#6BB3E8" />
          <circle cx="32" cy="16" r="8" fill="#FFE135" />
          <circle cx="32" cy="16" r="6" fill="#FFEC70" />
          <circle cx="30" cy="14" r="2" fill="#FFFFA0" />
          <rect x="0" y="32" width="64" height="32" fill="#0C1445" />
          <rect x="0" y="32" width="64" height="6" fill="#1A2866" />
          <circle cx="32" cy="48" r="7" fill="#E8E8E8" />
          <circle cx="32" cy="48" r="5" fill="#F4F4F4" />
          <circle cx="30" cy="46" r="1.5" fill="#C8C8C8" />
          <circle cx="34" cy="49" r="1" fill="#D0D0D0" />
          <circle cx="31" cy="51" r="0.8" fill="#D4D4D4" />
          <rect x="20" y="38" width="2" height="2" fill="#FFFFFF" />
          <rect x="44" y="42" width="2" height="2" fill="#FFFFFF" />
          <rect x="24" y="54" width="2" height="2" fill="#FFFFFF" />
          <rect x="40" y="56" width="2" height="2" fill="#FFFFFF" />
          <rect x="14" y="48" width="2" height="2" fill="#EEEEEE" />
          <rect x="50" y="50" width="2" height="2" fill="#EEEEEE" />
        </g>
        <circle
          cx="32"
          cy="32"
          r="30"
          fill="none"
          stroke="#B8860B"
          stroke-width="4"
        />
        <circle
          cx="32"
          cy="32"
          r="28"
          fill="none"
          stroke="#DAA520"
          stroke-width="4"
        />
        <circle
          cx="32"
          cy="32"
          r="24"
          fill="none"
          stroke="#C9922D"
          stroke-width="2"
        />
        <circle
          cx="32"
          cy="32"
          r="31"
          fill="none"
          stroke="#8B6914"
          stroke-width="1"
        />
        <rect x="26" y="2" width="4" height="2" fill="#FFE55C" />
        <rect x="34" y="2" width="4" height="2" fill="#FFE55C" />
        <rect x="18" y="6" width="2" height="2" fill="#FFE55C" />
        <rect x="44" y="6" width="2" height="2" fill="#FFE55C" />
        <rect x="26" y="60" width="4" height="2" fill="#8B6914" />
        <rect x="34" y="60" width="4" height="2" fill="#8B6914" />
        <rect x="18" y="56" width="2" height="2" fill="#8B6914" />
        <rect x="44" y="56" width="2" height="2" fill="#8B6914" />
        <circle
          cx="32"
          cy="32"
          r="22"
          fill="none"
          stroke="#5C4410"
          stroke-width="2"
        />
        <g clip-path="url(#bottomHalfEdit)">
          <circle cx="32" cy="32" r="21" fill="#DAA520" />
          <circle cx="32" cy="32" r="18" fill="#C9922D" />
          <circle cx="32" cy="32" r="15" fill="#B8860B" />
          <ellipse cx="32" cy="45" rx="12" ry="6" fill="#8B6914" />
        </g>
        <line
          x1="10"
          y1="32"
          x2="54"
          y2="32"
          stroke="#5C4410"
          stroke-width="2"
        />
        <polygon
          points="32,12 28,4 36,4"
          fill="#DAA520"
          stroke="#8B6914"
          stroke-width="1"
        />
        <polygon points="32,11 29,5 32,6" fill="#FFE55C" />
      </svg>
    </div>
    <span class="clock-phase-label" id="clock-phase-label">{{.Phase}}</span>
    <input
      type="number"
      class="clock-ticks-input"
      id="tick-input"
      value="{{.Ticks}}"
      min="0"
      max="24000"
      step="100"
    />
  </div>

  <div class="time-presets">
    <button
      type="button"
      class="mc-btn time-preset-btn"
      data-ticks="1000"
      data-label="day"
    >
      Day
    </button>
    <button
      type="button"
      class="mc-btn time-preset-btn"
      data-ticks="6000"
      data-label="noon"
    >
      Noon
    </button>
    <button
      type="button"
      class="mc-btn time-preset-btn"
      data-ticks="13000"
      data-label="night"
    >
      Night
    </button>
    <button
      type="button"
      class="mc-btn time-preset-btn"
      data-ticks="18000"
      data-label="midnight"
    >
      Midnight
    </button>
  </div>

  <div class="flex gap-2 w-full">
    <button
      type="button"
      class="mc-btn flex-1"
      hx-get="/world/clock"
      hx-target="#time-clock"
      hx-swap="outerHTML"
    >
      Cancel
    </button>
    <form
      id="set-time-form"
      class="flex-1"
      hx-post="/world/time"
      hx-target="#time-clock"
      hx-swap="outerHTML"
    >
      <input type="hidden" name="time" id="time-value" value="{{.Ticks}}" />
      <button type="submit" class="mc-btn w-full">Apply</button>
    </form>
  </div>
</div>

<script>
  (function () {
    const TICKS_PER_DAY = 24000;
    const clock = document.getElementById("mc-clock");
    const clockDisc = document.getElementById("clock-disc");
    const tickInput = document.getElementById("tick-input");
    const timeValueInput = document.getElementById("time-value");
    const phaseLabel = document.getElementById("clock-phase-label");
    const presetBtns = document.querySelectorAll(".time-preset-btn");

    let currentTicks = {{.Ticks}};
    let isDragging = false;

    const phases = [
      { start: 0, end: 1000, label: "Sunrise" },
      { start: 1000, end: 6000, label: "Morning" },
      { start: 6000, end: 12000, label: "Noon" },
      { start: 12000, end: 13000, label: "Sunset" },
      { start: 13000, end: 18000, label: "Night" },
      { start: 18000, end: 24000, label: "Midnight" },
    ];

    function getPhaseLabel(ticks) {
      for (const phase of phases) {
        if (ticks >= phase.start && ticks < phase.end) return phase.label;
      }
      return "Midnight";
    }

    function ticksToRotation(ticks) {
      return ((ticks - 6000) / TICKS_PER_DAY) * 360;
    }

    function angleToTicks(angle) {
      let ticks = (angle / 360) * TICKS_PER_DAY + 6000;
      return Math.round(((ticks % TICKS_PER_DAY) + TICKS_PER_DAY) % TICKS_PER_DAY);
    }

    function updateClockDisc(ticks) {
      clockDisc.setAttribute("transform", `rotate(${ticksToRotation(ticks)}, 32, 32)`);
    }

    function setTicks(ticks, updateInput = true) {
      ticks = Math.max(0, Math.min(TICKS_PER_DAY, Math.round(ticks)));
      currentTicks = ticks;
      if (updateInput) tickInput.value = ticks;
      timeValueInput.value = ticks;
      phaseLabel.textContent = getPhaseLabel(ticks);
      updateClockDisc(ticks);
    }

    function getAngleFromEvent(e) {
      const rect = clock.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return Math.atan2(clientX - centerX, -(clientY - centerY)) * (180 / Math.PI);
    }

    function startDrag(e) {
      isDragging = true;
      clock.classList.add("dragging");
      handleDrag(e);
      e.preventDefault();
    }

    function handleDrag(e) {
      if (!isDragging) return;
      setTicks(angleToTicks(getAngleFromEvent(e)));
    }

    function stopDrag() {
      isDragging = false;
      clock.classList.remove("dragging");
    }

    clock.addEventListener("mousedown", startDrag);
    clock.addEventListener("touchstart", startDrag, { passive: false });
    document.addEventListener("mousemove", handleDrag);
    document.addEventListener("touchmove", handleDrag, { passive: false });
    document.addEventListener("mouseup", stopDrag);
    document.addEventListener("touchend", stopDrag);

    presetBtns.forEach((btn) => {
      btn.addEventListener("click", function () {
        setTicks(parseInt(this.dataset.ticks));
      });
    });

    tickInput.addEventListener("input", function () {
      setTicks(parseInt(this.value) || 0, false);
    });

    tickInput.addEventListener("blur", function () {
      setTicks(currentTicks);
    });

    updateClockDisc(currentTicks);
  })();
</script>
