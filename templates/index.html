<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg" />
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/style.css?v=2" />
    <title>Minecraft Admin Tool</title>
  </head>
  <body>
    <header class="flex items-center justify-end gap-4">
      {{if .User}}
      <div class="flex items-center gap-3 text-sm">
        <img
          src="{{.User.AvatarURL}}"
          alt="{{.User.Username}}"
          class="player-avatar"
        />
        <div class="text-right">
          <p class="font-semibold">{{.User.Username}}</p>
        </div>
      </div>
      <form method="post" action="/auth/logout">
        <button type="submit" class="mc-btn">Log out</button>
      </form>
      {{end}}
    </header>
    <div class="container grid-layout">
      <aside class="mc-box flex flex-col gap-4">
        <div>
          <p class="text-xs uppercase tracking-wide text-muted">Control</p>
          <h1 class="mt-2">{{.ServerName}}</h1>
          <p class="text-sm mt-2 text-muted">{{.ServerDescription}}</p>
        </div>
        <nav class="flex flex-col gap-2">
          <button
            type="button"
            data-nav="overview"
            class="mc-btn w-full flex items-center gap-3 justify-start"
            onclick="window.location.href='/'"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
              <polyline points="9 22 9 12 15 12 15 22" />
            </svg>
            Overview
          </button>
          <button
            type="button"
            data-nav="whitelist"
            class="mc-btn w-full flex items-center gap-3 justify-start"
            hx-get="/whitelist"
            hx-target="#subpage-panel"
            hx-swap="innerHTML"
            hx-push-url="true"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
              <line x1="16" x2="16" y1="2" y2="6" />
              <line x1="8" x2="8" y1="2" y2="6" />
              <line x1="3" x2="21" y1="10" y2="10" />
              <path d="m9 16 2 2 4-4" />
            </svg>
            Whitelist
          </button>
          {{if .FilesEnabled}}
          <button
            type="button"
            data-nav="files"
            class="mc-btn w-full flex items-center gap-3 justify-start"
            hx-get="/files"
            hx-target="#subpage-panel"
            hx-swap="innerHTML"
            hx-push-url="true"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"
              />
            </svg>
            Files
          </button>
          {{end}}
          <button
            type="button"
            data-nav="console"
            class="mc-btn w-full flex items-center gap-3 justify-start"
            hx-get="/rcon"
            hx-target="#subpage-panel"
            hx-swap="innerHTML"
            hx-push-url="true"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="4 17 10 11 4 5" />
              <line x1="12" x2="20" y1="19" y2="19" />
            </svg>
            Console
          </button>
        </nav>
      </aside>
      <main class="flex flex-col gap-4">
        <section
          class="mc-box grid-layout"
          style="grid-template-columns: repeat(3, 1fr); gap: 1rem"
        >
          <div>
            <p class="text-xs uppercase tracking-wide text-muted">Address</p>
            <p class="mt-2">{{.ServerHost}}</p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wide text-muted">Game Port</p>
            <p class="mt-2">{{.ServerPort}}</p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wide text-muted">Version</p>
            <p class="mt-2">{{.ServerVersion}}</p>
          </div>
        </section>

        <section>
          <div
            id="player-list"
            hx-get="/server-info"
            hx-trigger="load, every 10s"
            hx-swap="innerHTML"
            class="mc-box"
          >
            <header
              class="mb-4"
              style="background: none; border: none; padding: 0"
            >
              <p class="text-xs uppercase tracking-wide text-muted">
                Live Players
              </p>
              <h2 class="mt-2">Online Right Now</h2>
            </header>
            <p class="text-sm">Loading player list...</p>
          </div>
        </section>
        <section>
          <div id="subpage-panel" class="mc-box flex flex-col">
            {{if eq .ActiveModule "whitelist"}} {{template "whitelist.html" .}}
            {{else if eq .ActiveModule "rcon"}} {{template
            "command_console.html" .}} {{else if eq .ActiveModule "files"}}
            {{template "files.html" .}} {{else}} {{end}}
          </div>
        </section>
      </main>
    </div>

    <div id="modal-root"></div>

    <script>
      const navButtons = document.querySelectorAll("[data-nav]");
      const subpagePanel = document.getElementById("subpage-panel");
      const defaultPanelContent = subpagePanel ? subpagePanel.innerHTML : "";
      const removeModal = () => {
        const modal = document.getElementById("kick-modal");
        if (modal) {
          modal.remove();
        }
      };

      navButtons.forEach((button) => {
        button.addEventListener("click", () => {
          // Reset all buttons (optional visual feedback logic can go here)
          if (subpagePanel && button.dataset.nav === "overview") {
            subpagePanel.innerHTML = defaultPanelContent;
          }
        });
      });

      document.body.addEventListener("click", (event) => {
        if (event.target?.dataset?.closeModal === "kick") {
          removeModal();
        }
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          removeModal();
        }
      });

      // Toast Notification System
      function showToast(message, type = "success") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = `
          <span>${message}</span>
          <button onclick="this.parentElement.remove()" style="background:none;border:none;cursor:pointer;color:inherit;font-family:inherit;font-size:inherit;">x</button>
        `;

        container.appendChild(toast);

        // Auto remove after 3 seconds
        setTimeout(() => {
          toast.classList.add("fadeOut");
          toast.addEventListener("animationend", () => {
            toast.remove();
          });
        }, 3000);
      }

      // Listen for HTMX events to trigger toasts
      document.body.addEventListener("showToast", function (evt) {
        showToast(evt.detail.message, evt.detail.type);
      });
    </script>
    <div id="toast-container"></div>
  </body>
</html>
