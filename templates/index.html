<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg" />
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js"></script>
    <link rel="stylesheet" href="/static/css/style.css?v={{assetVersion
    "/static/css/style.css"}}" />
    <title>Minecraft Admin Tool</title>
  </head>
  <body>
    <header>
      {{if .User}}
      <div class="user-info">
        <img
          src="{{.User.AvatarURL}}"
          alt="{{.User.Username}}"
          class="user-info__avatar"
        />
        <span class="user-info__name">{{.User.Username}}</span>
        <form method="post" action="/auth/logout">
          <button type="submit" class="mc-btn mc-btn--sm">Log out</button>
        </form>
      </div>
      {{end}}
    </header>

    <div class="container app-layout">
      <aside class="mc-panel sidebar">
        <div class="sidebar-header">
          <p class="sidebar-header__label">Control</p>
          <h1 class="sidebar-header__title">{{.ServerName}}</h1>
          <p class="sidebar-header__desc">{{.ServerDescription}}</p>
        </div>
        <nav class="nav">
          <button
            type="button"
            data-nav="overview"
            class="mc-btn nav-btn"
            onclick="window.location.href='/'"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
              <polyline points="9 22 9 12 15 12 15 22" />
            </svg>
            Home
          </button>
          <button
            type="button"
            data-nav="whitelist"
            class="mc-btn nav-btn"
            hx-get="/whitelist"
            hx-target="#subpage-panel"
            hx-swap="innerHTML"
            hx-push-url="true"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
              <line x1="16" x2="16" y1="2" y2="6" />
              <line x1="8" x2="8" y1="2" y2="6" />
              <line x1="3" x2="21" y1="10" y2="10" />
              <path d="m9 16 2 2 4-4" />
            </svg>
            Whitelist
          </button>
          {{if .FilesEnabled}}
          <button
            type="button"
            data-nav="files"
            class="mc-btn nav-btn"
            hx-get="/files"
            hx-target="#subpage-panel"
            hx-swap="innerHTML"
            hx-push-url="true"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"
              />
            </svg>
            Files
          </button>
          {{end}}
          <button
            type="button"
            data-nav="console"
            class="mc-btn nav-btn"
            hx-get="/rcon"
            hx-target="#subpage-panel"
            hx-swap="innerHTML"
            hx-push-url="true"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="4 17 10 11 4 5" />
              <line x1="12" x2="20" y1="19" y2="19" />
            </svg>
            Console
          </button>
          <button
            type="button"
            data-nav="user-stats"
            class="mc-btn nav-btn"
            hx-get="/users/stats"
            hx-target="#subpage-panel"
            hx-swap="innerHTML"
            hx-push-url="true"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
              <circle cx="12" cy="7" r="4" />
            </svg>
            User stats
          </button>
        </nav>
      </aside>

      <main>
        <div id="subpage-panel" class="mc-panel">
          {{if eq .ActiveModule "whitelist"}} {{template "whitelist.html" .}}
          {{else if eq .ActiveModule "world"}} {{template "world.html" .}}
          {{else if eq .ActiveModule "rcon"}} {{template "command_console.html"
          .}} {{else if eq .ActiveModule "files"}} {{template "files.html" .}}
          {{else if eq .ActiveModule "users"}} {{template "user_stats.html" .}}
          {{else}} {{end}}
        </div>
      </main>
    </div>

    <div id="modal-root"></div>

    <script>
      const navButtons = document.querySelectorAll("[data-nav]");
      const subpagePanel = document.getElementById("subpage-panel");
      const defaultPanelContent = subpagePanel ? subpagePanel.innerHTML : "";

      const removeModal = () => {
        const modal = document.getElementById("kick-modal");
        if (modal) modal.remove();
      };

      navButtons.forEach((button) => {
        button.addEventListener("click", () => {
          if (subpagePanel && button.dataset.nav === "overview") {
            subpagePanel.innerHTML = defaultPanelContent;
          }
        });
      });

      document.body.addEventListener("click", (event) => {
        if (event.target?.dataset?.closeModal === "kick") {
          removeModal();
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") removeModal();
      });

      function showToast(message, type = "success") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = `
          <span>${message}</span>
          <button class="toast-close" onclick="this.parentElement.remove()">x</button>
        `;
        container.appendChild(toast);
        setTimeout(() => {
          toast.classList.add("fadeOut");
          toast.addEventListener("animationend", () => toast.remove());
        }, 3000);
      }

      document.body.addEventListener("showToast", function (evt) {
        showToast(evt.detail.message, evt.detail.type);
      });

      // Delegate clicks for user-select buttons (works with HTMX-swapped content)
      document.body.addEventListener("click", function (ev) {
        const btn = ev.target.closest && ev.target.closest(".user-select");
        if (!btn) return;
        const uuid = btn.dataset.uuid;
        const raw =
          document.getElementById("user-stats-data")?.textContent || "[]";
        let users = [];
        try {
          users = JSON.parse(raw);
        } catch (e) {
          users = [];
        }
        const u = users.find((x) => x.UUID === uuid);
        const container = document.getElementById("user-stats-details");
        if (!container) return;
        if (!u) {
          container.innerHTML =
            '<p class="text-sm text-muted">Stats not found.</p>';
          return;
        }

        const custom = (u.Stats && u.Stats["minecraft:custom"]) || {};
        const used = (u.Stats && u.Stats["minecraft:used"]) || {};
        const picked = (u.Stats && u.Stats["minecraft:picked_up"]) || {};
        const killed = (u.Stats && u.Stats["minecraft:killed"]) || {};
        const killedBy = (u.Stats && u.Stats["minecraft:killed_by"]) || {};

        function fmtNumber(n) {
          return n === undefined || n === null ? 0 : n;
        }

        container.innerHTML = `
          <h3>${u.Name || u.UUID}</h3>
          <p><strong>UUID:</strong> ${u.UUID}</p>
          <div class="stats-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
            <div class="card"><strong>Play time</strong><div>${fmtNumber(
              custom["minecraft:play_time"]
            )}</div></div>
            <div class="card"><strong>Deaths</strong><div>${fmtNumber(
              custom["minecraft:deaths"]
            )}</div></div>
            <div class="card"><strong>Mob kills</strong><div>${fmtNumber(
              custom["minecraft:mob_kills"]
            )}</div></div>
            <div class="card"><strong>Jumps</strong><div>${fmtNumber(
              custom["minecraft:jump"]
            )}</div></div>
          </div>

          <h4 style="margin-top:12px;">Top items used</h4>
          <ul>${Object.entries(used)
            .slice(0, 10)
            .map(([k, v]) => `<li>${k}: ${v}</li>`)
            .join("")}</ul>

          <h4 style="margin-top:12px;">Top picked up</h4>
          <ul>${Object.entries(picked)
            .slice(0, 10)
            .map(([k, v]) => `<li>${k}: ${v}</li>`)
            .join("")}</ul>

          <h4 style="margin-top:12px;">Killed</h4>
          <ul>${
            Object.entries(killed)
              .map(([k, v]) => `<li>${k}: ${v}</li>`)
              .join("") || "<li>None</li>"
          }</ul>

          <h4 style="margin-top:12px;">Killed by</h4>
          <ul>${
            Object.entries(killedBy)
              .map(([k, v]) => `<li>${k}: ${v}</li>`)
              .join("") || "<li>None</li>"
          }</ul>
        `;

        // update visual selection
        document
          .querySelectorAll(".user-select")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
      });
    </script>
    <div id="toast-container"></div>
  </body>
</html>
