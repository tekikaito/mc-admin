<div class="flex flex-col gap-6">
  <!-- Header -->
  <div class="section-header">
    <h2 class="section-title m-0">Files</h2>
    <div class="flex gap-2">
      <button
        class="mc-btn mc-btn--sm"
        onclick="document.getElementById('create-modal').style.display='flex'"
      >
        New
      </button>
      <button
        class="mc-btn mc-btn--sm"
        onclick="document.getElementById('file-upload').click()"
      >
        Upload
      </button>
      <input
        type="file"
        id="file-upload"
        style="display: none"
        onchange="uploadFile(this)"
      />
    </div>
  </div>

  <!-- Breadcrumb -->
  <div class="flex flex-wrap items-center gap-2">
    <span class="text-sm text-muted">Path:</span>
    <code class="text-sm" style="word-break: break-all;">{{.CurrentPath}}</code>
    {{if ne .CurrentPath "/"}}
    <button
      class="mc-btn mc-btn--sm"
      hx-get="/files?path={{dir .CurrentPath | urlquery}}"
      hx-target="#subpage-panel"
    >
      Up
    </button>
    {{end}}
  </div>

  {{if .Error}}
  <div class="mc-panel--inset text-error">{{.Error}}</div>
  {{end}}

  <!-- File List -->
  <div class="player-list">
    {{range .Files}}
    <div class="file-list-item">
      <div class="file-list-item__name">
        {{if .IsDir}}
        <span class="text-muted text-sm">[DIR]</span>
        <a
          href="#"
          hx-get="/files?path={{joinPath $.CurrentPath .Name | urlquery}}"
          hx-target="#subpage-panel"
          class="font-bold"
        >{{.Name}}</a>
        {{else}}
        <span class="text-muted text-sm">[FILE]</span>
        <a
          href="#"
          hx-get="/files/content?path={{joinPath $.CurrentPath .Name | urlquery}}"
          hx-target="#file-content-display"
          hx-swap="innerHTML"
          onclick="document.getElementById('file-modal').style.display='flex'"
        >{{.Name}}</a>
        {{end}}
      </div>
      <div class="file-list-item__meta text-sm text-muted">
        <span>{{.Size}} B</span>
        <div class="dropdown">
          <button class="mc-btn mc-btn--sm" onclick="toggleDropdown(event, this)">
            Actions
          </button>
          <div class="dropdown-content">
            <button onclick="copyPath('{{joinPath $.CurrentPath .Name}}')">
              Copy Path
            </button>
            {{if not .IsDir}}
            <a href="/files/download?path={{joinPath $.CurrentPath .Name | urlquery}}">
              Download
            </a>
            {{end}}
            <button
              class="text-error"
              hx-delete="/files/delete?path={{joinPath $.CurrentPath .Name | urlquery}}"
              hx-confirm="Are you sure?"
              hx-target="#subpage-panel"
              hx-swap="innerHTML"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>
    {{end}}
  </div>
</div>

<!-- File Content Modal -->
<div id="file-modal" class="modal-overlay" style="display: none;">
  <div class="modal" style="max-width: 900px; width: 100%; height: 80vh; display: flex; flex-direction: column;">
    <div class="flex justify-between items-center mb-4">
      <h3 class="m-0">File Content</h3>
      <button
        class="mc-btn mc-btn--sm"
        onclick="document.getElementById('file-modal').style.display='none'"
      >
        Close
      </button>
    </div>
    <pre id="file-content-display" class="console-output flex-1" style="height: auto; margin: 0; overflow: auto;"></pre>
  </div>
</div>

<!-- Create Modal -->
<div id="create-modal" class="modal-overlay" style="display: none;">
  <div class="modal" style="width: 100%;">
    <h3 class="m-0 mb-4">Create New</h3>
    <form id="create-form" class="flex flex-col gap-4">
      <div class="input-group">
        <label for="new-name">Name</label>
        <input type="text" id="new-name" class="mc-input" required />
      </div>
      <div class="input-group">
        <label for="new-type">Type</label>
        <select id="new-type" class="mc-input">
          <option value="file">File</option>
          <option value="dir">Directory</option>
        </select>
      </div>
      <div class="input-group" id="content-field">
        <label for="new-content">Content</label>
        <textarea id="new-content" class="mc-input" rows="5"></textarea>
      </div>
      <div class="flex justify-end gap-3">
        <button
          type="button"
          class="mc-btn"
          onclick="document.getElementById('create-modal').style.display='none'"
        >
          Cancel
        </button>
        <button type="button" class="mc-btn" onclick="submitCreateForm()">
          Create
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  function uploadFile(input) {
    if (input.files.length === 0) return;

    const file = input.files[0];
    const formData = new FormData();
    formData.append("file", file);
    formData.append("path", "{{.CurrentPath}}");

    fetch("/files/upload", {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          showToast("Error: " + data.error, "error");
        } else {
          showToast(`File '${file.name}' uploaded successfully`, "success");
          htmx.ajax(
            "GET",
            "/files?path=" + encodeURIComponent("{{.CurrentPath}}"),
            "#subpage-panel"
          );
        }
        input.value = "";
      })
      .catch((error) => {
        showToast("Error: " + error, "error");
        input.value = "";
      });
  }

  document.getElementById("new-type").addEventListener("change", function (e) {
    document.getElementById("content-field").style.display =
      e.target.value === "dir" ? "none" : "block";
  });

  function submitCreateForm() {
    const name = document.getElementById("new-name").value;
    const type = document.getElementById("new-type").value;
    const content = document.getElementById("new-content").value;
    const currentPath = "{{.CurrentPath}}";

    let fullPath = name;
    if (currentPath !== "/") {
      fullPath = currentPath.endsWith("/")
        ? currentPath + name
        : currentPath + "/" + name;
    } else {
      fullPath = "/" + name;
    }

    fetch("/files/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        path: fullPath,
        content: content,
        is_dir: type === "dir",
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          showToast("Error: " + data.error, "error");
        } else {
          showToast(`'${name}' created successfully`, "success");
          document.getElementById("create-modal").style.display = "none";
          htmx.ajax(
            "GET",
            "/files?path=" + encodeURIComponent("{{.CurrentPath}}"),
            "#subpage-panel"
          );
        }
      })
      .catch((error) => {
        showToast("Error: " + error, "error");
      });
  }

  function toggleDropdown(event, btn) {
    event.stopPropagation();
    document.querySelectorAll(".dropdown").forEach((d) => {
      if (d !== btn.parentElement) d.classList.remove("show");
    });
    btn.parentElement.classList.toggle("show");
  }

  function copyPath(path) {
    navigator.clipboard.writeText(path).then(
      () => showToast("Path copied to clipboard", "success"),
      () => showToast("Failed to copy path", "error")
    );
  }

  document.addEventListener("click", function (event) {
    if (!event.target.matches(".dropdown button")) {
      document.querySelectorAll(".dropdown").forEach((d) => d.classList.remove("show"));
    }
  });
</script>
